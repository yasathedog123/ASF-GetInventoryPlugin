# 两步验证

Steam 支持被称作“Escrow”的两步验证系统，在进行各种与帐户相关的操作时，需要额外的确认。 您可在[**此处**](https://help.steampowered.com/faqs/view/2E6E-A02C-5581-8904)与[**此处**](https://help.steampowered.com/faqs/view/34A1-EA3F-83ED-54AB)了解更多详情。 本页主要介绍这种两步验证系统本身，以及我们对此系统的集成方案，即 ASF 两步验证（ASF 2FA）。

---

# ASF 逻辑

无论您是否使用 ASF 两步验证，ASF 都包含正确逻辑且完全了解如何处理由标准两步验证器所保护的帐户。 它将在有需要的时候（如登录时）向您请求所需的详细信息。 然而，通过使用 ASF 两步验证，我们可以自动生成所需的令牌，使这类请求自动化，为您免除麻烦并启用额外功能（下文所述）。

---

# ASF 两步验证

ASF 2FA 是为 ASF 进程提供 2FA 特性支持的内部模块，包括生成令牌和确认交易。 它的工作原理是复制您已有验证器的密钥，所以您可以同时使用原有验证器和 ASF 2FA。

您可以执行 `2fa` [**命令**](https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Commands-zh-CN)来验证机器人帐户是否已经启用 ASF 2FA。 除非您已经将验证器导入为 ASF 2FA，否则所有标准 `2fa` 命令都是无效的，这意味着您的帐户没有启用 ASF 2FA，因此一些需要此模块的 ASF 高级功能也无法正常运行。

---

# 建议

有多种方法使 ASF 2FA 正常工作，我们在此列出根据您当前情况提供的建议：

- 如果您已经在使用 SteamDesktopAuthenticator、WinAuth 或其他任何可以方便导出 2FA 信息的第三方应用，则只需[**导入**](#导入)到 ASF。
- 如果您正在使用官方应用，并且不在意是否重置 2FA 凭据，则最好的方式是禁用 2FA，然后通过[**联合身份验证器**](#联合身份验证器)来[**创建**](#创建)新的 2FA 凭据，这将允许您同时使用官方应用和 ASF 2FA。 此方法不需要 root 或进阶知识，只需要按指示操作。
- 如果您正在使用官方应用，并且不想重新创建您的 2FA 凭据，则您的选项是非常有限的，通常您需要 root 环境，以及一些额外操作来[**导入**](#导入)信息，甚至某些情况下是完全不可能做到的。
- 如果您还没有使用 2FA，并且不在意由什么应用管理，则可以用[**独立身份验证器**](#独立身份验证器)来管理 ASF 2FA，或将第三方应用[**导入**](#导入)到 ASF（推荐 #1），或将[**联合身份验证器**](#联合身份验证器)与官方应用结合起来使用（推荐 #2）。

我们将在下面讨论所有可能的选项和已知的方法。

---

## 创建

一般来说，我们强烈建议[**复制**](#导入)您现有的验证器，因为这就是 ASF 2FA 的主要设计目标。 但是，ASF 官方提供了 `MobileAuthenticator` [**插件**](https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Plugins-zh-CN)，进一步扩展了 ASF 2FA 的功能，允许您从头开始绑定新验证器。 这是为了以防万一您不能或不愿意使用其他工具，并且不介意以 ASF 2FA 作为您的主验证器（可能也是唯一的验证器）。

借助 `MobileAuthenticator` **[插件](https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Plugins-zh-CN)**，目前有两种场景来添加两步验证器：独立验证器或与官方手机应用联合的验证器。 在第二种场景中，您将在 ASF 和手机应用中使用相同的验证器，两者会生成相同的代码，两者都能确认交易报价，完成 Steam 社区交易等。

### 所有场景下的相同步骤

无论您打算使用 ASF 作为独立验证器还是想使用和官方 Steam 手机应用相同的验证器，您都需要进行这些初始步骤：

1. 为目标帐户创建 ASF 机器人，启动它并登录，您可能已经这样做过了。
2. 可选地，在[**这里**](https://store.steampowered.com/phone/manage)为机器人的帐户绑定能够正常使用的手机号码。 这将允许您接收短信代码，并在需要时恢复帐户，但这一步不是必须的。
3. 确保帐户上没有绑定 2FA，如果有，请先禁用。
4. 执行 `2fainit [Bot]` 命令，其中的 `[Bot]` 应替换为您指定机器人的名字。

假设您得到了成功的回复，就会发生以下两件事：

- ASF 会在 `config` 文件夹下生成一份新的 `<Bot>.maFile.PENDING` 文件。
- Steam 会向您绑定的手机号码发送一条短信。 如果您没有设置手机号码，则会向您的帐户邮箱发送一封电子邮件。

此时验证器还不能正常工作，但如果您愿意，可以看看生成的文件。 如果您希望获得双保险，可以在这时就记下恢复码。 接下来的步骤取决于您选择的场景。

### 独立身份验证器

如果您想以 ASF 作为主要的（甚至是唯一的）验证器，现在您需要完成以下收尾步骤：

5. 执行 `2fafinalize [Bot] <ActivationCode>`  命令，其中的 `[Bot]` 应替换为您指定机器人的名字，`<ActivationCode>` 应替换为您在之前步骤中通过短信或邮件收到的代码。

### 联合身份验证器

如果您想在 ASF 中和官方 Steam 手机应用中使用相同的验证器，现在您需要进行这些步骤：

5. 忽略您在之前步骤中收到的短信或邮件。
6. 如果您尚未安装 Steam 手机应用，请安装并打开它。 前往 Steam 令牌页面，并按照应用的提示添加一个新的身份验证器。
7. 在手机应用中添加身份验证器并可以正常使用后，回到 ASF。 您现在需要告诉 ASF 已完成创建，您可以使用下列命令之一：
 - 等待 Steam 手机应用中显示新 2FA 代码，然后执行命令 `2fafinalized [Bot] <2fa_code_from_app>`，其中 `[Bot]` 应替换为您的机器人名字，而 `<2fa_code_from_app>` 应替换为您此时在 Steam 手机应用上看到的代码。 如果 ASF 生成的代码与您提供的代码相同，ASF 会认为身份验证器已正确添加，并继续导入您新建的验证器。
 - 我们强烈推荐您使用上面的方法来确保凭据信息是有效的。 然而，如果您不想或不能检查二者的代码是否相同，并且您清楚自己要做什么，您可以改用 `2fafinalizedforce [Bot]` 命令，其中 `[Bot]` 应替换为您的机器人名字。 ASF 会认为已经正确添加身份验证器，并继续导入您新建的验证器。

### 完成之后

假设一切都正常工作，之前生成的 `<Bot>.maFile.PENDING` 会被重命名为 `<Bot>.maFile.NEW`。 这表示您的 2FA 凭据现在是有效并正常工作的。 我们建议您复制一份文件，保存在**安全的位置**。 除此之外，我们还建议您用文本编辑器打开它，并记下其中的 `revocation_code`（恢复码），顾名思义，如果您丢失了验证器，可以通过此代码移除。

至于其中的技术细节，生成的 `maFile` 包含了我们绑定验证器时从 Steam 服务器获取到的所有信息，包括其他验证器可能需要的 `device_id` 字段。 这份文件与 **[SDA](#steamdesktopauthenticator)** 完全兼容，可以直接用于导入。

一旦完成上述流程，ASF 就会自动导入您的验证器，因此，`2fa` 等相关命令此时应该已经对您绑定的机器人生效。

---

## 导入

导入过程需要您已拥有且绑定了受 ASF 支持的可用验证器。 除了允许您手动提供所需的凭据之外，ASF 还支持导入不同来源的、或官方或非官方的两步验证——Android、iOS、SteamDesktopAuthenticator 和 WinAuth。 如果您还没有任何验证器，就需要选择上述可用的验证器之一，并首先设置好它。 如果您不知道选择哪个更好，我们推荐 WinAuth，但只要您正确按照说明操作，上述的任何一个验证器都可以正常工作。

以下所有指南都需要您在指定的工具/应用中已有**正常工作**的验证器。 如果导入了无效数据，ASF 2FA 将无法正常运行，因此在尝试导入之前，请确保您的验证器正常工作。 这包括测试和验证以下验证器功能是否正常工作：
- 您可以生成令牌，并且 Steam 网络接受这些令牌
- 您可以获取交易确认，并且您的手机验证器也可以收到这些确认
- 您可以接受这些交易确认，并且 Steam 网络能够正确将它们识别为已接受/已拒绝

检查上述操作是否正常来确保您的验证器正常工作——如果不正常，它们也不会在 ASF 中正常运作，不仅浪费您的时间，还会带来其他麻烦。

---

### Android 手机

**以下说明适用于 Steam 应用 `2.X` 版本，目前只有有限的[**方式**](https://github.com/JustArchiNET/ArchiSteamFarm/discussions/2786)从 `3.0` 及以上版本中提取所需的信息。 一旦找到普遍可用的方法，我们会更新本节的信息。 到今天为止，一种可行的临时解决方案是有意地安装旧版 Steam 应用，在其中注册 2FA，然后提取出所需的信息，随后可以更新应用到最新版本——原有的验证器仍能继续工作。**

一般情况下，从 Android 手机导入验证器需要您拥有 **[root](https://en.wikipedia.org/wiki/Rooting_(Android_OS))** 权限。 不同的设备有不同的 root 方法，所以我无法告诉您如何 root 您的设备。 您可以访问 **[XDA](https://www.xda-developers.com/root)** 查找相关的指南，以及关于 root 的一般信息。 如果您找不到适合您设备的指南，可以再尝试在搜索引擎中搜索。

至少从官方角度来说，没有 root 权限就无法访问受保护的 Steam 文件。 目前唯一正式的无需 root 的提取 Steam 文件的方法是以某种方法制作一份未加密的 `/data` 的备份，然后在 PC 上手动提取所需的文件，但这种功能在很大程度上依赖于您的手机制造商，并且**不属于** Android 标准，因此我们不会在此讨论该方法。 如果您的设备很幸运支持这样的功能，您可以使用它，但大多数用户没有这种东西。

也有无需 root 权限的非正式方法，即安装或者降级 Steam 应用为 `2.1` 或者更旧版本，在此版本绑定手机验证器，然后通过 `adb backup` 命令创建一份应用的快照（包含我们所需的 `data` 文件）。 然而，由于该方法属于严重的安全漏洞以及不受支持的提取文件的方式，我们不会进一步详述这一点，Valve 在新版本中禁用了这个安全漏洞，我们在此提及此方法仅仅是把它作为一种可能性。 不过，也许可以全新安装这个旧版本，绑定新手机验证器，提取初所需的文件，然后再升级应用，这样理论上会有效，但您需要自己尝试。

假设您已经成功 root 了您的手机，接下来您应该在应用商店下载任何一款 root 文件管理器，例如[**这个**](https://play.google.com/store/apps/details?id=com.jrummy.root.browserfree)（或者任何您喜爱的类似应用）。 您也可以通过 ADB（Android Debug Bridge，Android 调试桥）或者任何其他可用的方法访问受保护的文件，我们采用文件管理器是因为这是对大多数用户最友好的方式。

打开 root 文件管理器之后，前往 `/data/data` 文件夹。 请注意，`/data/data` 文件夹受保护，如果您没有 root 权限则无法访问它。 然后，找到 `com.valvesoftware.android.steam.community` 文件夹，将它复制到您的 `/sdcard` 文件夹，也就是您的内置存储设备。 之后，您应该可以将手机连接到 PC，将上述文件夹从内置存储设备复制到 PC 上。 如果您无法看见这个文件夹，但您确定您已经将它复制到了正确的位置，请先尝试重新启动手机。

现在，您可以选择先将验证器导入到 WinAuth，再导入到 ASF，或者直接导入到 ASF。 第一个选项更友好，使您在 PC 上也复制一份验证器，这样您就有 3 种方式确认交易和生成令牌——您的手机、您的 PC 和 ASF。 如果您要这样做，只需要打开 WinAuth，添加新的 Steam 验证器，然后选择从 Android 设备导入，按照屏幕上的指示访问之前您获取到的文件。 完成后，您可以从 WinAuth 将验证器导入 ASF，详见下文 WinAuth 一节。

如果您不想这样做，或者只是不想用 WinAuth，则可以直接从受保护文件夹中复制 `files/Steamguard-<SteamID>` 文件，其中 `SteamID` 是您要添加的帐户的 64 位 ID（可能有多个文件，如果只有一个帐户则只有一个文件）。 您需要将这个文件放入 ASF 的 `config` 文件夹。 完成这一步之后，将此文件重命名为 `BotName.maFile`，其中 `BotName` 是您需要导入 ASF 2FA 的机器人名称。 在这一步之后，运行 ASF——它将会发现 `.maFile` 文件并导入。

```text
[*] INFO: ImportAuthenticator() <1> 正在将 .maFile 转换为 ASF 格式……
[*] INFO: ImportAuthenticator() <1> 成功导入手机验证器！
```

假如您导入了含有有效密钥的正确文件，一切都应该正常工作，您可以使用 `2fa` 命令来验证。 如果您不小心做错了，也可以随时删除 `Bot.db` 文件以重新开始这个过程。

---

### iOS

对于 iOS 设备，您可以使用 **[ios-steamguard-extractor](https://github.com/CaitSith2/ios-steamguard-extractor)**。 其原理是您可以制作一份解密后的备份，将其放到 PC 上，用这个工具从中解出 Steam 数据，这些数据原本是无法获得的（因为 iOS 的加密机制，至少在不越狱的情况下不行）。

前往[**发布页面**](https://github.com/CaitSith2/ios-steamguard-extractor/releases/latest)下载此程序的最新版本。 在您提取数据之后，可以将其导入 WinAuth，然后再从 WinAuth 导入 ASF（但您也可以将生成的 json 文件中从 `{` 到 `}` 的部分复制到 `BotName.maFile` 文件中再继续）。 如果您问我的看法，我强烈建议先导入 WinAuth，然后确认生成令牌和交易确认都能够正常工作，这样您就可以确保之前的操作没有问题。 如果您的凭据无效，ASF 2FA 将不会正常工作，所以最好将 ASF 的导入步骤放在最后。

如果有问题，请访问 **[Issues](https://github.com/CaitSith2/ios-steamguard-extractor/issues)** 页面。

*请注意，上述工具是非官方的，您需要自行承担使用的风险。 如果它不能正常工作，我们无法提供技术支持——我们得到一些反馈称其导出的 2FA 凭据无效——请在向 ASF 导入之前，在 WinAuth 之类的验证器中验证交易确认功能正常工作！*

---

### SteamDesktopAuthenticator

如果您已有运行于 SDA 中的验证器，您应该已经注意到 `maFiles` 文件夹下有 `steamID.maFile` 文件。 确保 `maFile` 是未加密形式，因为 ASF 无法解密 SDA 文件——未加密的文件内容应该以 `{` 符号开头，以 `}` 结尾。 如果需要，您可以先在 SDA 设置中移除加密，然后在导入后重新启用。 文件解密之后，将它复制到 ASF 的 `config` 文件夹。

现在您可以将 `steamID.maFile` 文件重命名为 `BotName.maFile` 并将其放入 ASF 配置文件夹，其中 `BotName` 是您需要导入 ASF 2FA 的机器人名称。 或者，您可以将其保持原样，ASF 将会在登录帐户后自动选择此文件。 如果您在这一步帮助 ASF 重命名，ASF 就可以在登录之前使用 ASF 2FA，否则，ASF 就只能在成功登录之后导入文件（因为 ASF 在登录之前无法获取您帐户的 `steamID`）。

如果一切正确，启动 ASF，您将会看到：

```text
[*] INFO: ImportAuthenticator() <1> 正在将 .maFile 转换为 ASF 格式……
[*] INFO: ImportAuthenticator() <1> 成功导入手机验证器！
```

从现在开始，此帐户的 ASF 2FA 功能已经可用。

---

### WinAuth

首先在 ASF 的配置文件夹内新建一个空的 `BotName.maFile` 文件，其中 `BotName` 是您需要导入 ASF 2FA 的机器人名称。 记住，文件名应该为 `BotName.maFile` 而不是 `BotName.maFile.txt`，Windows 默认会隐藏文件的扩展名。 如果您提供的文件名错误，ASF 将无法识别它。

现在像平常一样启动 WinAuth。 右键单击 Steam 图标，选择“Show SteamGuard and Recovery Code”。 然后勾选“Allow copy”。 您应该能在窗口底部找到熟悉的以 `{` 开头的 JSON 结构。 将完整文本复制到上一步创建的 `BotName.maFile` 文件中。

如果一切正确，启动 ASF，您将会看到：

```text
[*] INFO: ImportAuthenticator() <1> 正在将 .maFile 转换为 ASF 格式……
[*] INFO: ImportAuthenticator() <1> 成功导入手机验证器！
```

从现在开始，此帐户的 ASF 2FA 功能已经可用。

---

## 完成导入

从此，所有的 `2fa` 命令将会像原有的 2FA 设备一样正常工作。 您可以用 ASF 2FA 和其他验证器（Android、iOS、SDA 或 WinAuth）生成令牌或者接受确认。

如果您的手机上有验证器，也可以选择移除 SteamDesktopAuthenticator 和/或 WinAuth，因为我们不再需要它了。 不过，我建议保留它们以防万一，而且它们比官方的 Steam 验证器更好用。 需要注意的是，ASF 2FA **不是**通用的验证器，它不包括验证器所需的所有数据，而只记录了原始 `maFile` 的部分内容。 无法将 ASF 2FA 转换成原始的验证器，因此请始终确保您在其他地方（如 WinAuth、SDA 或手机）有完整功能的通用验证器或者 `maFile`。

---

## 常见问题

### ASF 的两步验证模块的作用是？

如果 ASF 2FA 可用，ASF 将会使用它来自动确认 ASF 所发送/接受的交易报价。 它还能够在需要时自动生成两步验证令牌，例如在登录时。 除此之外，拥有 ASF 2FA 也会为您启用 `2fa` 命令。 如果我没记错的话，这就是目前的所有功能——基本上 ASF 会按需使用 2FA 模块。

---

### 如果我需要一份两步验证令牌该怎么做？

您需要两步验证令牌才能访问受两步验证保护的帐户，这也包括启用了 ASF 2FA 的帐户。 您应该在原有的身份验证器中生成令牌，但您也可以通过聊天向指定机器人发送 `2fa` 命令，生成临时令牌。 您也可以使用 `2fa <BotNames>` 命令为指定的机器人实例生成临时令牌。 在浏览器等环境中访问机器人帐户时，这种方法应该足够用了，但如上文所述——您应该使用更友好的验证器（Android、iOS、SDA 或 WinAuth）来代替。

---

### 将验证器导入 ASF 2FA 之后，我原来的验证器还能用吗？

是的，您原有的验证器会保留所有功能，并且可以与 ASF 2FA 一起使用。 整个过程的重点是——我们将您的验证器凭据导入 ASF，使 ASF 可以利用它们代表您接受选定的交易确认。

---

### ASF 将验证器数据存放在哪里？

ASF 验证器数据被保存在配置文件文件夹的 `BotName.db` 文件里，这个文件中也包含指定帐户的其他关键数据。 如果您希望移除 ASF 2FA，请阅读下文。

---

### 如何移除 ASF 2FA？

只需要关闭 ASF 并移除指定机器人的 `BotName.db` 文件。 此选项将会移除 ASF 与导入的两步验证的关联，但不会解绑您的身份验证器。 如果您打算解绑验证器，除了将其从 ASF 删除外，还需要在您原有的验证器设备上（Android、iOS、SDA 或 WinAuth）解绑，或者，如果您已无法使用验证器，则应该在 Steam 网站上使用绑定验证器时保存的恢复代码。 您无法通过 ASF 解绑您的验证器，这也是您已拥有的一般用途验证器的目标。

---

### 我在 SDA/WinAuth 中启用了验证器，然后将它导入了 ASF。 我现在可以解绑原来的验证器，然后重新绑定我的手机吗？

**不**。 ASF 是为了使用目的**导入**您的验证器数据。 如果您解绑了验证器，无论您是否像上文所述移除了它，ASF 2FA 都会失效。 如果您想在手机和 ASF 上（包括 SDA/WinAuth）同时使用身份验证器，您需要从手机中**导入**验证器，而不是在 SDA/WinAuth 中创建新的验证器。 您只能绑定**一个**验证器，这也是 ASF **导入**您的验证器及其数据的原因——它们是**同一个**验证器，只是在两个不同的位置。 如果您决定解绑您的手机验证器凭据——无论以何种方式，ASF 2FA 都会停止工作，因为之前复制的手机验证器凭据将会失效。 若要同时使用 ASF 2FA 和您手机上的验证器，您必须如上所述从 Android/iOS 导入。

---

### 使用 ASF 2FA 批量确认交易比 WinAuth/SDA/其他验证器更好吗？

从几个方面来说，**是的**。 第一点也是最重要的一点——使用 ASF 2FA 会**显著**增强安全性，因为 ASF 2FA 模块会确保 ASF 只自动接受它自己的确认，所以即使攻击者向您发送了有害的交易请求，ASF 2FA 也**不会**接受此交易，因为它并非来自 ASF。 除了更安全，使用 ASF 2FA 也会对性能/优化有帮助，因为 ASF 2FA 会且只会在生成交易报价之后立刻获取并确认交易请求，而不是像 SDA 或者 WinAuth 那样低效地每隔 X 分钟拉取一次交易确认。 简而言之，如果您计划自动确认来自 ASF 的报价，就没有理由使用其他第三方验证器代替 ASF 2FA——这正是 ASF 2FA 的作用，并且这与您使用其他验证器确认其他交易并不冲突。 我们强烈建议您为所有 ASF 活动启用 ASF 2FA——这比其他的解决方案更安全。

---

## 高级

如果您是高级用户，也可以手动生成 maFile。 如果您希望从上述其他来源导入验证器，则可能需要这样做。 它的[**有效 JSON 结构**](https://jsonlint.com)如下：

```json
{
  "shared_secret": "STRING",
  "identity_secret": "STRING"
}
```

标准的身份验证器数据含有更多字段——在导入过程中，ASF 会完全忽略这些字段，因为 ASF 不需要它们。 您不必删除它们——只要 JSON 中有上述强制要求的 2 个字段就可以，ASF 会忽略额外提供的字段（如果存在）。 当然，您需要将上述示例中的 `STRING` 占位符替换为与您的帐号关联的实际内容。 每个 `STRING` 都应该是构成对应私钥的字节的 Base64 编码形式。
